<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d0d">
<title>ğŸ¥– CRMB â€” Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø¨Ø²</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d0d;--bg2:#111;--bg3:#1a1a1a;--border:#2a2a2a;
  --gold:#D4A843;--white:#e0e0e0;--muted:#888;
  --green:#27ae60;--red:#e74c3c;--blue:#3498db;--purple:#9b59b6;--orange:#e67e22;
}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;
  background-image:radial-gradient(ellipse at 20% 10%,#1a1200 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,#0a1a0a 0%,transparent 50%)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#111}
::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
button{cursor:pointer;font-family:'Cairo',sans-serif}
input,select,textarea{font-family:'Cairo',sans-serif;outline:none}
input:focus,select:focus{border-color:var(--gold)!important;box-shadow:0 0 0 2px rgba(212,168,67,.2)}

/* HEADER */
#header{background:linear-gradient(135deg,#1a1200,#0d0d0d);border-bottom:1px solid #2a2000;
  padding:0 16px;display:flex;align-items:center;justify-content:space-between;
  height:60px;position:sticky;top:0;z-index:100;gap:8px}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo .icon{font-size:26px}
.logo .title{color:var(--gold);font-weight:700;font-size:16px;line-height:1.1}
.logo .sub{color:#666;font-size:10px}
.hcontrols{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.sync-badge{background:#1a2a1a;border:1px solid #27ae6040;border-radius:8px;
  padding:4px 10px;color:#27ae60;font-size:11px;display:flex;align-items:center;gap:4px;white-space:nowrap}
.sync-badge.syncing{background:#1a1a2a;border-color:#3498db40;color:#3498db}
.sync-badge.offline{background:#2a1a1a;border-color:#e74c3c40;color:#e74c3c}
.user-badge{background:#1a1a00;border:1px solid #D4A84330;border-radius:8px;
  padding:4px 10px;color:#D4A843;font-size:11px;cursor:pointer;white-space:nowrap}

/* LAYOUT */
#layout{display:flex;min-height:calc(100vh - 60px)}

/* SIDEBAR */
#sidebar{width:190px;background:#111;border-left:1px solid #1e1e1e;
  padding:16px 0;flex-shrink:0;position:sticky;top:60px;height:calc(100vh - 60px);overflow-y:auto}
.nav-btn{width:100%;background:transparent;border:none;border-right:3px solid transparent;
  color:#666;padding:12px 16px;text-align:right;font-size:13px;font-weight:400;
  display:flex;align-items:center;gap:8px;transition:all .2s}
.nav-btn:hover{color:#aaa;background:rgba(255,255,255,.03)}
.nav-btn.active{background:linear-gradient(90deg,#2a1800,#1a1200);border-right-color:var(--gold);color:var(--gold);font-weight:700}
.nav-divider{border-bottom:1px solid #1e1e1e;margin:8px 0}

/* MAIN */
#main{flex:1;padding:20px;overflow-y:auto;min-width:0}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:22px}
.kpi-card{background:rgba(255,255,255,.04);border-radius:14px;padding:16px 18px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.05)}
.kpi-icon{position:absolute;top:-8px;right:-6px;font-size:52px;opacity:.07}
.kpi-label{color:#aaa;font-size:12px;margin-bottom:5px;font-weight:500}
.kpi-value{font-size:20px;font-weight:700;font-family:monospace}
.kpi-sub{color:#666;font-size:11px;margin-top:3px}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
thead tr{background:#1a1a1a}
thead th{padding:10px 13px;color:var(--gold);font-size:12px;font-weight:600;text-align:right;white-space:nowrap}
tbody tr{border-bottom:1px solid #1e1e1e;transition:background .15s}
tbody tr:hover td{background:rgba(255,255,255,.02)}
tbody td{padding:10px 13px;font-size:13px;color:#ddd;vertical-align:middle}

/* SECTION */
.sec-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.sec-title{color:var(--gold);font-size:19px;font-weight:700}

/* BUTTONS */
.btn{border:none;border-radius:10px;color:#fff;padding:8px 16px;font-weight:600;font-size:13px;transition:opacity .2s}
.btn:hover{opacity:.85}
.btn-gold{background:var(--gold);color:#000}
.btn-green{background:var(--green)}
.btn-red{background:var(--red)}
.btn-blue{background:var(--blue)}
.btn-purple{background:var(--purple)}
.btn-orange{background:var(--orange)}
.btn-dark{background:#333}
.btn-sm{padding:5px 11px;font-size:12px;border-radius:8px}

/* PROGRESS */
.prog-bar{background:#222;border-radius:4px;height:8px;overflow:hidden}
.prog-fill{border-radius:4px;height:8px;transition:width 1s}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;
  display:flex;align-items:center;justify-content:center;padding:16px}
.modal-box{background:#141414;border-radius:18px;padding:26px;width:100%;max-width:460px;
  border:1px solid #2a2a2a;max-height:92vh;overflow-y:auto}
.modal-title{color:var(--gold);margin-bottom:18px;font-size:17px;font-weight:700}
.form-field{margin-bottom:13px}
.form-label{color:#aaa;font-size:12px;margin-bottom:5px;display:block;font-weight:500}
.form-input{background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;padding:9px 12px;width:100%;font-size:14px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.hint-box{padding:11px 13px;border-radius:9px;margin-bottom:13px;font-size:13px}
.hint-green{background:#0d1a0d;color:var(--green);border:1px solid #27ae6030}
.hint-gold{background:#1a1500;color:var(--gold);border:1px solid #D4A84330}
.hint-red{background:#1a0808;color:var(--red);border:1px solid #e74c3c30}

/* NOTIFICATION */
#notif{position:fixed;top:16px;left:50%;transform:translateX(-50%);
  background:var(--green);color:#fff;padding:10px 22px;border-radius:12px;
  z-index:9999;font-size:14px;font-weight:600;
  box-shadow:0 4px 20px rgba(0,0,0,.4);animation:fadeInDown .3s ease;display:none}
@keyframes fadeInDown{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* BARCODE */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px}
.product-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.product-card-head{background:#1a1500;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222}
.product-card-body{padding:12px;background:#fff;display:flex;justify-content:center}
.product-card-stats{padding:10px 15px;display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid #1a1a1a}
.stat-item{text-align:center}
.stat-label{color:#888;font-size:10px;margin-bottom:2px}
.stat-value{font-weight:700;font-size:13px}
.product-card-actions{padding:10px 13px;display:flex;gap:7px}

/* PnL */
.pnl-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #1a1a1a;font-size:13px}
.pnl-total{display:flex;justify-content:space-between;padding:10px 0;border-top:2px solid #333;font-weight:700;font-size:14px}

/* USER MANAGEMENT */
.user-card{background:#1a1a1a;border-radius:12px;padding:14px 16px;border:1px solid #2a2a2a;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}

/* MOBILE BOTTOM NAV */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:#111;border-top:1px solid #222;grid-template-columns:repeat(4,1fr);height:58px}
.bnav-btn{background:transparent;border:none;color:#555;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:2px;font-size:9px;padding:4px 0;transition:color .2s}
.bnav-btn.active{color:var(--gold)}
.bnav-btn span:first-child{font-size:20px}
#more-nav{background:#1a1a1a;border-radius:14px 14px 0 0;position:fixed;bottom:58px;
  left:0;right:0;padding:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
  border:1px solid #333;border-bottom:none;z-index:199;display:none}
.bnav-more-btn{background:#222;border:none;border-radius:10px;color:#aaa;
  padding:12px 8px;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px}
.bnav-more-btn.active{color:var(--gold);background:#2a1800}

/* CHART */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:90px;padding:0 4px}
.bar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.bar-val{font-size:9px;color:#888;text-align:center}
.bar-fill{width:100%;border-radius:4px 4px 0 0;min-height:4px;transition:height .8s}
.bar-lbl{font-size:9px;color:#888;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:50px}

/* RESPONSIVE */
@media(max-width:768px){
  #sidebar{display:none}
  #main{padding:14px;padding-bottom:72px}
  #bottom-nav{display:grid}
  .kpi-grid{grid-template-columns:1fr 1fr;gap:10px}
  .kpi-value{font-size:16px!important}
  .form-row{grid-template-columns:1fr}
  .product-grid{grid-template-columns:1fr}
  .sec-title{font-size:16px}
}
</style>
</head>
<body>

<div id="notif"></div>

<!-- HEADER -->
<div id="header">
  <div class="logo">
    <span class="icon">ğŸ¥–</span>
    <div>
      <div class="title">CRMB</div>
      <div class="sub">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø¨Ø²</div>
    </div>
  </div>
  <div class="hcontrols">
    <div class="sync-badge" id="syncBadge">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    <div class="user-badge" onclick="showTab('profile')" id="userBadge">ğŸ‘¤ ...</div>
    <button class="btn btn-green" onclick="exportExcel()" style="padding:6px 12px;font-size:12px">ğŸ“¥ Excel</button>
    <select id="monthSelect" class="form-input" style="width:120px;padding:6px 10px;font-size:12px" onchange="changeMonth(this.value)"></select>
  </div>
</div>

<!-- LAYOUT -->
<div id="layout">
  <div id="sidebar">
    <button class="nav-btn active" onclick="showTab('dashboard')" id="nav-dashboard"><span>ğŸ“Š</span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button class="nav-btn" onclick="showTab('revenue')" id="nav-revenue"><span>ğŸ’°</span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
    <button class="nav-btn" onclick="showTab('materials')" id="nav-materials"><span>ğŸŒ¾</span>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</button>
    <button class="nav-btn" onclick="showTab('employees')" id="nav-employees"><span>ğŸ‘¥</span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</button>
    <button class="nav-btn" onclick="showTab('expenses')" id="nav-expenses"><span>ğŸ“‹</span>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
    <button class="nav-btn" onclick="showTab('rent')" id="nav-rent"><span>ğŸ </span>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</button>
    <button class="nav-btn" onclick="showTab('reports')" id="nav-reports"><span>ğŸ“ˆ</span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button class="nav-btn" onclick="showTab('barcode')" id="nav-barcode"><span>ğŸ·ï¸</span>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <div class="nav-divider"></div>
    <button class="nav-btn" onclick="showTab('users')" id="nav-users"><span>ğŸ”‘</span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button>
    <button class="nav-btn" onclick="showTab('profile')" id="nav-profile"><span>âš™ï¸</span>Ø­Ø³Ø§Ø¨ÙŠ</button>
    <button class="nav-btn" style="color:#e74c3c" onclick="doLogout()"><span>ğŸšª</span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>
  <div id="main"></div>
</div>

<!-- BOTTOM NAV -->
<div id="bottom-nav">
  <button class="bnav-btn active" onclick="showTab('dashboard')" id="bnav-dashboard"><span>ğŸ“Š</span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button class="bnav-btn" onclick="showTab('revenue')" id="bnav-revenue"><span>ğŸ’°</span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
  <button class="bnav-btn" onclick="showTab('barcode')" id="bnav-barcode"><span>ğŸ·ï¸</span>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
  <button class="bnav-btn" onclick="toggleMore()" id="bnav-more-btn"><span>â˜°</span>Ø§Ù„Ù…Ø²ÙŠØ¯</button>
</div>
<div id="more-nav">
  <button class="bnav-more-btn" onclick="showTab('materials');toggleMore()"><span>ğŸŒ¾</span>Ø§Ù„Ù…ÙˆØ§Ø¯</button>
  <button class="bnav-more-btn" onclick="showTab('employees');toggleMore()"><span>ğŸ‘¥</span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</button>
  <button class="bnav-more-btn" onclick="showTab('expenses');toggleMore()"><span>ğŸ“‹</span>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
  <button class="bnav-more-btn" onclick="showTab('reports');toggleMore()"><span>ğŸ“ˆ</span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button class="bnav-more-btn" onclick="showTab('profile');toggleMore()"><span>âš™ï¸</span>Ø­Ø³Ø§Ø¨ÙŠ</button>
  <button class="bnav-more-btn" style="color:#e74c3c" onclick="doLogout()"><span>ğŸšª</span>Ø®Ø±ÙˆØ¬</button>
</div>

<div id="modal-container"></div>

<script>
// ==========================================
//  STATE
// ==========================================
let appData = null;
let currentUser = null;
let currentTab = 'dashboard';
let moreOpen = false;
let saveTimer = null;
let syncStatus = 'syncing';

const MONTHS = ["2025-01","2025-02","2025-03","2025-04","2025-05","2025-06","2025-07","2025-08","2025-09","2025-10","2025-11","2025-12","2026-01","2026-02","2026-03","2026-04","2026-05","2026-06","2026-07","2026-08","2026-09","2026-10","2026-11","2026-12","2027-01","2027-02","2027-03","2027-04","2027-05","2027-06"];
const MN = ["","ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
const ml = m => { const [y,mo]=m.split('-'); return `${MN[+mo]} ${y}`; };
const fc = n => new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR',minimumFractionDigits:0}).format(n||0);

// ==========================================
//  API CALLS
// ==========================================
async function apiFetch(url, opts={}) {
  try {
    const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
    if (r.status === 401) { window.location.href='/login'; return null; }
    return r.json();
  } catch { return null; }
}

async function loadData() {
  setSyncBadge('syncing');
  const data = await apiFetch('/api/data');
  if (data) { appData = data; setSyncBadge('online'); }
  else { setSyncBadge('offline'); }
  return !!data;
}

async function saveData() {
  setSyncBadge('syncing');
  const res = await apiFetch('/api/data', { method:'POST', body:JSON.stringify(appData) });
  setSyncBadge(res?.ok ? 'online' : 'offline');
}

function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveData, 600);
}

function setSyncBadge(status) {
  syncStatus = status;
  const b = document.getElementById('syncBadge');
  if (!b) return;
  const map = { online:['ğŸŸ¢ Ù…ØªØ²Ø§Ù…Ù†',''], syncing:['ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸','syncing'], offline:['ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„','offline'] };
  b.textContent = map[status][0];
  b.className = 'sync-badge' + (map[status][1] ? ' '+map[status][1] : '');
}

// ==========================================
//  BARCODE
// ==========================================
const C128=['11011001100','11001101100','11001100110','10010011000','10010001100','10001001100','10011001000','10011000100','10001100100','11001001000','11001000100','11000100100','10110011100','10011011100','10011001110','10111001100','10011101100','10011100110','11001110010','11001011100','11001001110','11011100100','11001110100','11101101110','11101001100','11100101100','11100100110','11101100100','11100110100','11100110010','11011011000','11011000110','11000110110','10100011000','10001011000','10001000110','10110001000','10001101000','10001100010','11010001000','11000101000','11000100010','10110111000','10110001110','10001101110','10111011000','10111000110','10001110110','11101110110','11010001110','11000101110','11011101000','11011100010','11011101110','11101011000','11101000110','11100010110','11101101000','11101100010','11100011010','11101111010','11001000010','11110001010','10100110000','10100001100','10010110000','10010000110','10000101100','10000100110','10110010000','10110000100','10011010000','10011000010','10000110100','10000110010','11000010010','11001010000','11110111010','11000010100','10001111010','10100111100','10010111100','10010011110','10111100100','10011110100','10011110010','11110100100','11110010100','11110010010','11011011110','11011110110','11110110110','10101111000','10100011110','10001011110'];
function buildBarPattern(text){let sum=104,pat='11010010000';for(let i=0;i<text.length;i++){const v=text.charCodeAt(i)-32;if(v<0||v>=C128.length)continue;sum+=v*(i+1);pat+=C128[v];}pat+=C128[sum%103]+'1100011101011';return pat;}
function drawBarcode(cid,val,w=240,h=50){
  const c=document.getElementById(cid);if(!c||!val)return;
  const pat=buildBarPattern(val),ctx=c.getContext('2d'),dpr=window.devicePixelRatio||1;
  c.width=(w+2)*dpr;c.height=(h+18)*dpr;c.style.width=(w+2)+'px';c.style.height=(h+18)+'px';
  ctx.scale(dpr,dpr);ctx.fillStyle='#fff';ctx.fillRect(0,0,w+2,h+18);
  const bw=w/pat.length;ctx.fillStyle='#000';
  for(let i=0;i<pat.length;i++){if(pat[i]==='1')ctx.fillRect(1+i*bw,0,Math.ceil(bw),h);}
  ctx.fillStyle='#000';ctx.font='10px monospace';ctx.textAlign='center';ctx.fillText(val,(w+2)/2,h+13);
}
function genBC(){return "628"+Math.floor(Math.random()*9999999999).toString().padStart(10,'0').substr(0,10);}
function drawAllBarcodes(){(appData.products||[]).forEach(p=>drawBarcode('bc-'+p.id,p.barcode));}

// ==========================================
//  TABS
// ==========================================
function showTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.nav-btn,.bnav-btn,.bnav-more-btn').forEach(b=>b.classList.remove('active'));
  ['nav-','bnav-','bnav-more-'].forEach(p=>{const el=document.getElementById(p+tab);if(el)el.classList.add('active');});
  renderMain();
  if(moreOpen) toggleMore();
  window.scrollTo(0,0);
}
function toggleMore(){
  moreOpen=!moreOpen;
  document.getElementById('more-nav').style.display=moreOpen?'grid':'none';
}
function changeMonth(v){appData.currentMonth=v;scheduleSave();renderMain();}

// ==========================================
//  CALCULATIONS
// ==========================================
function calcStats() {
  const cm=appData.currentMonth;
  const totalSalaries=appData.employees.reduce((s,e)=>s+e.salary+e.housing,0);
  const totalRaw=appData.rawMaterials.filter(r=>r.month===cm).reduce((s,r)=>s+r.qty*r.unitCost,0);
  const totalExp=appData.expenses.filter(e=>e.month===cm).reduce((s,e)=>s+e.amount,0);
  const totalRev=appData.revenue.filter(r=>r.month===cm).reduce((s,r)=>s+r.amount,0);
  const totalCosts=totalSalaries+totalRaw+totalExp+appData.rent.amount;
  const netProfit=totalRev-totalCosts;
  const margin=totalRev>0?((netProfit/totalRev)*100).toFixed(1):0;
  return{totalSalaries,totalRaw,totalExp,totalRev,totalCosts,netProfit,margin,cm};
}

// ==========================================
//  RENDER MAIN
// ==========================================
function renderMain() {
  const main=document.getElementById('main');
  const s=calcStats();
  const renders={
    dashboard:()=>renderDashboard(s),
    revenue:()=>renderRevenue(s),
    materials:()=>renderMaterials(s),
    employees:()=>renderEmployees(s),
    expenses:()=>renderExpenses(s),
    rent:()=>renderRent(s),
    reports:()=>renderReports(s),
    barcode:()=>renderBarcode(),
    users:()=>renderUsers(),
    profile:()=>renderProfile(),
  };
  main.innerHTML = (renders[currentTab]||renders.dashboard)();
  if(currentTab==='barcode') setTimeout(drawAllBarcodes,80);
}

// ---- helpers ----
const kpi=(label,value,icon,color,sub='')=>`<div class="kpi-card" style="border-color:${color}30"><div class="kpi-icon">${icon}</div><div class="kpi-label">${label}</div><div class="kpi-value" style="color:${color}">${value}</div>${sub?`<div class="kpi-sub">${sub}</div>`:''}</div>`;
const srow=(label,val,vc,bold,pct,pc)=>`<tr><td style="font-weight:${bold?700:400}">${label}</td><td style="color:${vc};font-weight:${bold?700:400}">${fc(val)}</td><td style="color:${pc||'#888'}">${pct}</td></tr>`;

// ---- DASHBOARD ----
function renderDashboard(s){
  const revItems=appData.revenue.filter(r=>r.month===s.cm);
  const maxRev=Math.max(...revItems.map(r=>r.amount),1);
  return`<div class="sec-header"><div class="sec-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ${ml(s.cm)}</div></div>
  <div class="kpi-grid">
    ${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',fc(s.totalRev),'ğŸ’°','var(--green)','Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±')}
    ${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ',fc(s.totalCosts),'ğŸ“‰','var(--red)','Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ')}
    ${kpi('ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­',fc(s.netProfit),'ğŸ“Š',s.netProfit>=0?'var(--green)':'var(--red)',`Ù‡Ø§Ù…Ø´ ${s.margin}%`)}
    ${kpi('Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø³ÙƒÙ†',fc(s.totalSalaries),'ğŸ‘¥','var(--blue)',`${appData.employees.length} Ù…ÙˆØ¸Ù`)}
    ${kpi('Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…',fc(s.totalRaw),'ğŸŒ¾','var(--orange)','Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±')}
    ${kpi('Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',fc(appData.rent.amount),'ğŸ ','var(--purple)','Ø´Ù‡Ø±ÙŠ')}
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
    <div style="background:var(--bg2);border-radius:14px;padding:18px;border:1px solid var(--border)">
      <div style="color:var(--gold);font-weight:700;margin-bottom:14px;font-size:14px">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</div>
      ${[{l:'Ø±ÙˆØ§ØªØ¨ ÙˆØ³ÙƒÙ†',v:s.totalSalaries,c:'var(--blue)'},{l:'Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…',v:s.totalRaw,c:'var(--orange)'},{l:'Ø¥ÙŠØ¬Ø§Ø±',v:appData.rent.amount,c:'var(--purple)'},{l:'Ù…ØµØ§Ø±ÙŠÙ',v:s.totalExp,c:'var(--red)'}].map(i=>{const p=s.totalCosts>0?((i.v/s.totalCosts)*100).toFixed(1):0;return`<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:#bbb">${i.l}</span><span style="font-size:12px;color:${i.c};font-weight:600">${fc(i.v)}</span></div><div class="prog-bar"><div class="prog-fill" style="width:${p}%;background:${i.c}"></div></div></div>`}).join('')}
    </div>
    <div style="background:var(--bg2);border-radius:14px;padding:18px;border:1px solid var(--border)">
      <div style="color:var(--gold);font-weight:700;margin-bottom:14px;font-size:14px">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      <div class="bar-chart">${revItems.length===0?'<p style="color:#555;font-size:12px;margin:auto">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>':revItems.map(r=>`<div class="bar-item"><div class="bar-val">${(r.amount/1000).toFixed(0)}k</div><div class="bar-fill" style="height:${(r.amount/maxRev*75)}px;background:var(--green)"></div><div class="bar-lbl">${r.source}</div></div>`).join('')}</div>
    </div>
  </div>
  <div style="background:var(--bg2);border-radius:14px;padding:18px;border:1px solid var(--border)">
    <div style="color:var(--gold);font-weight:700;margin-bottom:14px;font-size:14px">Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</div>
    <div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody>
      ${srow('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',s.totalRev,'var(--green)',true,'100%','var(--green)')}
      ${srow('Ø±ÙˆØ§ØªØ¨ ÙˆØ³ÙƒÙ†',s.totalSalaries,'var(--red)',false,s.totalRev>0?((s.totalSalaries/s.totalRev)*100).toFixed(1)+'%':'-')}
      ${srow('Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…',s.totalRaw,'var(--red)',false,s.totalRev>0?((s.totalRaw/s.totalRev)*100).toFixed(1)+'%':'-')}
      ${srow('Ø¥ÙŠØ¬Ø§Ø±',appData.rent.amount,'var(--red)',false,s.totalRev>0?((appData.rent.amount/s.totalRev)*100).toFixed(1)+'%':'-')}
      ${srow('Ù…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„',s.totalExp,'var(--red)',false,s.totalRev>0?((s.totalExp/s.totalRev)*100).toFixed(1)+'%':'-')}
      ${srow('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ',s.totalCosts,'var(--red)',true,s.totalRev>0?((s.totalCosts/s.totalRev)*100).toFixed(1)+'%':'-')}
      ${srow(s.netProfit>=0?'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­':'ØµØ§ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©',Math.abs(s.netProfit),s.netProfit>=0?'var(--green)':'var(--red)',true,s.margin+'%',s.netProfit>=0?'var(--green)':'var(--red)')}
    </tbody></table></div>
  </div>`;
}

// ---- REVENUE ----
function renderRevenue(s){
  const items=appData.revenue.filter(r=>r.month===s.cm);
  return`<div class="sec-header"><div class="sec-title">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª â€” ${ml(s.cm)}</div><button class="btn btn-green" onclick="openModal('revenue')">+ Ø¥Ø¶Ø§ÙØ©</button></div>
  <div class="kpi-grid" style="grid-template-columns:1fr">${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',fc(s.totalRev),'ğŸ’°','var(--green)')}</div>
  <div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>
    ${items.map(r=>`<tr><td style="font-weight:600">${r.source}</td><td>${ml(r.month)}</td><td style="color:var(--green);font-weight:600">${fc(r.amount)}</td><td><div style="display:flex;gap:5px"><button class="btn btn-blue btn-sm" onclick="openModal('revenue',${r.id})">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-red btn-sm" onclick="del('revenue',${r.id})">Ø­Ø°Ù</button></div></td></tr>`).join('')}
    ${items.length===0?'<tr><td colspan="4" style="text-align:center;color:#555;padding:28px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td></tr>':''}
  </tbody></table></div>`;
}

// ---- MATERIALS ----
function renderMaterials(s){
  const items=appData.rawMaterials.filter(r=>r.month===s.cm);
  return`<div class="sec-header"><div class="sec-title">ğŸŒ¾ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… â€” ${ml(s.cm)}</div><button class="btn btn-orange" onclick="openModal('material')">+ Ø¥Ø¶Ø§ÙØ©</button></div>
  <div class="kpi-grid" style="grid-template-columns:1fr">${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯',fc(s.totalRaw),'ğŸŒ¾','var(--orange)')}</div>
  <div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>
    ${items.map(r=>`<tr><td style="font-weight:600">${r.name}</td><td>${r.qty}</td><td>${r.unit}</td><td>${fc(r.unitCost)}</td><td style="color:var(--orange);font-weight:600">${fc(r.qty*r.unitCost)}</td><td><div style="display:flex;gap:5px"><button class="btn btn-blue btn-sm" onclick="openModal('material',${r.id})">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-red btn-sm" onclick="del('material',${r.id})">Ø­Ø°Ù</button></div></td></tr>`).join('')}
    ${items.length===0?'<tr><td colspan="6" style="text-align:center;color:#555;padding:28px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</td></tr>':''}
  </tbody></table></div>`;
}

// ---- EMPLOYEES ----
function renderEmployees(s){
  return`<div class="sec-header"><div class="sec-title">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</div><button class="btn btn-blue" onclick="openModal('employee')">+ Ø¥Ø¶Ø§ÙØ©</button></div>
  <div class="kpi-grid">
    ${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨',fc(appData.employees.reduce((a,e)=>a+e.salary,0)),'ğŸ’¼','var(--blue)')}
    ${kpi('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙƒÙ†',fc(appData.employees.reduce((a,e)=>a+e.housing,0)),'ğŸ¡','var(--purple)')}
    ${kpi('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',fc(s.totalSalaries),'ğŸ‘¥','var(--orange)',`${appData.employees.length} Ù…ÙˆØ¸Ù`)}
  </div>
  <div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ù†ØµØ¨</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>Ø§Ù„Ø³ÙƒÙ†</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>
    ${appData.employees.map(e=>`<tr><td style="font-weight:600">${e.name}</td><td style="color:#aaa">${e.role}</td><td>${fc(e.salary)}</td><td style="color:var(--purple)">${fc(e.housing)}</td><td style="color:var(--blue);font-weight:600">${fc(e.salary+e.housing)}</td><td><div style="display:flex;gap:5px"><button class="btn btn-blue btn-sm" onclick="openModal('employee',${e.id})">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-red btn-sm" onclick="del('employee',${e.id})">Ø­Ø°Ù</button></div></td></tr>`).join('')}
  </tbody></table></div>`;
}

// ---- EXPENSES ----
function renderExpenses(s){
  const items=appData.expenses.filter(e=>e.month===s.cm);
  const cats=items.reduce((a,e)=>{a[e.category]=(a[e.category]||0)+e.amount;return a},{});
  return`<div class="sec-header"><div class="sec-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” ${ml(s.cm)}</div><button class="btn btn-red" onclick="openModal('expense')">+ Ø¥Ø¶Ø§ÙØ©</button></div>
  <div class="kpi-grid">${Object.entries(cats).map(([c,v])=>kpi(c,fc(v),'ğŸ“‹','var(--red)')).join('')}</div>
  <div class="table-wrap"><table><thead><tr><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>
    ${items.map(e=>`<tr><td style="font-weight:600">${e.category}</td><td>${ml(e.month)}</td><td style="color:var(--red);font-weight:600">${fc(e.amount)}</td><td style="color:#666">${e.note||'â€”'}</td><td><div style="display:flex;gap:5px"><button class="btn btn-blue btn-sm" onclick="openModal('expense',${e.id})">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn btn-red btn-sm" onclick="del('expense',${e.id})">Ø­Ø°Ù</button></div></td></tr>`).join('')}
    ${items.length===0?'<tr><td colspan="5" style="text-align:center;color:#555;padding:28px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</td></tr>':''}
  </tbody></table></div>`;
}

// ---- RENT ----
function renderRent(s){
  return`<div class="sec-header"><div class="sec-title">ğŸ  Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø­Ù„</div></div>
  <div style="background:var(--bg2);border-radius:18px;padding:26px;border:1px solid #2a1800;max-width:420px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div><div style="color:#aaa;font-size:13px">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><div style="color:var(--purple);font-size:32px;font-weight:700">${fc(appData.rent.amount)}</div></div>
      <span style="font-size:46px">ğŸ </span>
    </div>
    <div style="color:#888;margin-bottom:6px">ÙŠØ³ØªØ­Ù‚ ÙŠÙˆÙ… <strong style="color:#aaa">${appData.rent.dueDay}</strong> Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</div>
    ${appData.rent.note?`<div style="color:#888;margin-bottom:14px">${appData.rent.note}</div>`:''}
    <button class="btn btn-purple" onclick="openModal('rent')">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</button>
  </div>`;
}

// ---- REPORTS ----
function renderReports(s){
  const expCats=appData.expenses.filter(e=>e.month===s.cm).reduce((a,e)=>{a[e.category]=(a[e.category]||0)+e.amount;return a},{});
  return`<div class="sec-header"><div class="sec-title">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â€” ${ml(s.cm)}</div></div>
  <div style="background:var(--bg2);border-radius:14px;padding:20px;border:1px solid var(--border);margin-bottom:18px">
    <div style="color:var(--gold);font-weight:700;margin-bottom:16px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
      <div>
        <div style="color:var(--green);font-weight:700;margin-bottom:10px;font-size:14px">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        ${appData.revenue.filter(r=>r.month===s.cm).map(r=>`<div class="pnl-row"><span style="color:#bbb">${r.source}</span><span style="color:var(--green);font-weight:600">${fc(r.amount)}</span></div>`).join('')}
        <div class="pnl-total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span style="color:var(--green)">${fc(s.totalRev)}</span></div>
      </div>
      <div>
        <div style="color:var(--red);font-weight:700;margin-bottom:10px;font-size:14px">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        <div class="pnl-row"><span style="color:#bbb">Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span><span style="color:var(--red)">${fc(appData.employees.reduce((a,e)=>a+e.salary,0))}</span></div>
        <div class="pnl-row"><span style="color:#bbb">Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†</span><span style="color:var(--red)">${fc(appData.employees.reduce((a,e)=>a+e.housing,0))}</span></div>
        <div class="pnl-row"><span style="color:#bbb">Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø­Ù„</span><span style="color:var(--red)">${fc(appData.rent.amount)}</span></div>
        <div class="pnl-row"><span style="color:#bbb">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</span><span style="color:var(--red)">${fc(s.totalRaw)}</span></div>
        ${Object.entries(expCats).map(([c,v])=>`<div class="pnl-row"><span style="color:#bbb">${c}</span><span style="color:var(--red)">${fc(v)}</span></div>`).join('')}
        <div class="pnl-total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span style="color:var(--red)">${fc(s.totalCosts)}</span></div>
      </div>
    </div>
    <div style="margin-top:18px;padding:16px;border-radius:12px;background:${s.netProfit>=0?'rgba(39,174,96,.1)':'rgba(192,57,43,.1)'};border:1px solid ${s.netProfit>=0?'#27ae6040':'#c0392b40'}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:15px;font-weight:700">${s.netProfit>=0?'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­':'ØµØ§ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©'}</span>
        <span style="font-size:24px;font-weight:700;color:${s.netProfit>=0?'var(--green)':'var(--red)'}">${fc(Math.abs(s.netProfit))}</span>
      </div>
      <div style="color:#888;font-size:12px;margin-top:5px">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­: ${s.margin}% | Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„: ${fc(s.totalCosts)}</div>
    </div>
  </div>
  <div style="background:var(--bg2);border-radius:14px;padding:20px;border:1px solid var(--border)">
    <div style="color:var(--gold);font-weight:700;margin-bottom:16px">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</div>
    ${[{l:'Ø±ÙˆØ§ØªØ¨ ÙˆØ³ÙƒÙ†',v:s.totalSalaries,c:'var(--blue)'},{l:'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…',v:s.totalRaw,c:'var(--orange)'},{l:'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',v:appData.rent.amount,c:'var(--purple)'},{l:'Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ´ØºÙŠÙ„',v:s.totalExp,c:'var(--red)'}].map(i=>{const p=s.totalCosts>0?((i.v/s.totalCosts)*100).toFixed(1):0;return`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:13px">${i.l}</span><span style="color:${i.c};font-weight:600">${fc(i.v)} (${p}%)</span></div><div class="prog-bar" style="height:11px"><div class="prog-fill" style="width:${p}%;background:${i.c}"></div></div></div>`}).join('')}
  </div>`;
}

// ---- BARCODE ----
function renderBarcode(){
  const prods=appData.products||[];
  return`<div class="sec-header"><div class="sec-title">ğŸ·ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ±</div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-blue" onclick="printAllBC()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
    <button class="btn btn-gold" onclick="openModal('product')">+ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
  </div></div>
  ${prods.length===0?`<div style="text-align:center;color:#555;padding:60px"><div style="font-size:46px;margin-bottom:12px">ğŸ·ï¸</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª â€” Ø§Ø¶ØºØ· "Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯"</div></div>`:''}
  <div class="product-grid">
    ${prods.map(p=>{const m=p.price>0?(((p.price-p.cost)/p.price)*100).toFixed(0):0;return`
    <div class="product-card">
      <div class="product-card-head">
        <div><div style="color:#fff;font-weight:700;font-size:14px">${p.name}</div><div style="color:var(--gold);font-size:11px;margin-top:2px">${p.category} â€¢ ${p.unit}</div></div>
        <div style="text-align:left"><div style="color:var(--green);font-size:17px;font-weight:700">${fc(p.price)}</div><div style="color:#666;font-size:10px">Ù‡Ø§Ù…Ø´: ${m}%</div></div>
      </div>
      <div class="product-card-body"><canvas id="bc-${p.id}"></canvas></div>
      <div class="product-card-stats">
        <div class="stat-item"><div class="stat-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</div><div class="stat-value" style="color:var(--green)">${fc(p.price)}</div></div>
        <div class="stat-item"><div class="stat-label">Ø§Ù„ØªÙƒÙ„ÙØ©</div><div class="stat-value" style="color:var(--red)">${fc(p.cost)}</div></div>
        <div class="stat-item"><div class="stat-label">Ø§Ù„Ø±Ø¨Ø­</div><div class="stat-value" style="color:var(--gold)">${fc(p.price-p.cost)}</div></div>
      </div>
      <div class="product-card-actions">
        <button class="btn btn-blue btn-sm" style="flex:1" onclick="printLabel(${p.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn btn-dark btn-sm" onclick="openModal('product',${p.id})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-red btn-sm" onclick="del('product',${p.id})">Ø­Ø°Ù</button>
      </div>
    </div>`;}).join('')}
  </div>`;
}

// ---- USERS ----
function renderUsers(){
  if(!currentUser||currentUser.role!=='admin') return`<div style="text-align:center;padding:60px;color:#555"><div style="font-size:36px;margin-bottom:12px">ğŸ”’</div><div>Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</div></div>`;
  return`<div class="sec-header"><div class="sec-title">ğŸ”‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><button class="btn btn-green" onclick="openModal('newuser')">+ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button></div>
  <div class="hint-box hint-gold" style="margin-bottom:18px">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† â€” ÙƒÙ„ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ù‡ Ø§Ù„Ø®Ø§ØµØ©</div>
  <div id="users-list"><div style="text-align:center;color:#555;padding:20px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>`;
}
async function loadUsersList(){
  if(currentTab!=='users')return;
  const users=await apiFetch('/api/users');
  const list=document.getElementById('users-list');
  if(!list)return;
  if(!users){list.innerHTML='<div style="color:var(--red);text-align:center">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';return;}
  list.innerHTML=users.map(u=>`<div class="user-card">
    <div>
      <div style="font-weight:600;font-size:15px">${u.name}</div>
      <div style="color:#888;font-size:12px">@${u.username} â€¢ ${u.role==='admin'?'<span style="color:var(--gold)">Ù…Ø¯ÙŠØ±</span>':'Ù…ÙˆØ¸Ù'}</div>
    </div>
    <div style="display:flex;gap:8px">
      ${u.id!==currentUser.id?`<button class="btn btn-red btn-sm" onclick="deleteUser(${u.id})">Ø­Ø°Ù</button>`:'<span style="color:#555;font-size:12px">Ø£Ù†Øª</span>'}
    </div>
  </div>`).join('');
}

// ---- PROFILE ----
function renderProfile(){
  return`<div class="sec-header"><div class="sec-title">âš™ï¸ Ø­Ø³Ø§Ø¨ÙŠ</div></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:600px">
    <div style="background:var(--bg2);border-radius:14px;padding:22px;border:1px solid var(--border)">
      <div style="font-size:40px;text-align:center;margin-bottom:14px">ğŸ‘¤</div>
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:700;color:var(--gold)">${currentUser?.name||''}</div>
        <div style="color:#888;font-size:13px;margin-top:4px">@${currentUser?.username||''}</div>
        <div style="color:var(--purple);font-size:12px;margin-top:4px">${currentUser?.role==='admin'?'ğŸ”‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…':'ğŸ‘· Ù…ÙˆØ¸Ù'}</div>
      </div>
    </div>
    <div style="background:var(--bg2);border-radius:14px;padding:22px;border:1px solid var(--border)">
      <div style="color:var(--gold);font-weight:700;margin-bottom:16px">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
      <div class="form-field"><label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><input class="form-input" type="password" id="oldpw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <div class="form-field"><label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input class="form-input" type="password" id="newpw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <div class="form-field"><label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input class="form-input" type="password" id="conpw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <button class="btn btn-purple" style="width:100%" onclick="changePassword()">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <div id="pw-msg" style="margin-top:10px;font-size:13px;text-align:center;display:none"></div>
    </div>
  </div>
  <div style="margin-top:14px;max-width:600px">
    <button class="btn btn-red" onclick="doLogout()" style="width:100%;padding:12px;font-size:15px">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>`;
}

// ==========================================
//  MODAL FORMS
// ==========================================
function openModal(type, id=null){
  let item=null;
  const map={employee:appData.employees,expense:appData.expenses,material:appData.rawMaterials,revenue:appData.revenue,product:appData.products||[]};
  if(id&&map[type]) item=map[type].find(x=>x.id===id);
  if(type==='rent') item=appData.rent;
  document.getElementById('modal-container').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" onclick="event.stopPropagation()">${buildForm(type,item,id)}</div></div>`;
  if(type==='product'&&item?.barcode) setTimeout(()=>drawBarcode('mbc',item.barcode,200,43),80);
}
function closeModal(){document.getElementById('modal-container').innerHTML='';}

function buildForm(type,item,id){
  const cm=appData.currentMonth;
  const mOpts=MONTHS.map(m=>`<option value="${m}" ${(item?.month||cm)===m?'selected':''}>${ml(m)}</option>`).join('');
  const isEdit=!!id;
  if(type==='employee') return`
    <div class="modal-title">${isEdit?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù':'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù'}</div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ø§Ø³Ù… *</label><input class="form-input" id="f-name" value="${item?.name||''}" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ù…Ù†ØµØ¨</label><input class="form-input" id="f-role" value="${item?.role||''}" placeholder="Ø®Ø¨Ø§Ø²..."></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Ø§Ù„Ø±Ø§ØªØ¨ *</label><input class="form-input" id="f-salary" type="number" value="${item?.salary||''}"></div>
      <div class="form-field"><label class="form-label">Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†</label><input class="form-input" id="f-housing" type="number" value="${item?.housing||''}"></div>
    </div>
    <div style="display:flex;gap:10px"><button class="btn btn-blue" style="flex:1" onclick="saveEmp(${id||'null'})">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='expense') return`
    <div class="modal-title">${isEdit?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ':'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ'}</div>
    <div class="form-field"><label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ *</label><select class="form-input" id="f-cat">${["ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ù…Ø§Ø¡","ØºØ§Ø²","Ø¥Ù†ØªØ±Ù†Øª","Ù‡Ø§ØªÙ","ØµÙŠØ§Ù†Ø©","ØªØ£Ù…ÙŠÙ†","Ù†Ø¸Ø§ÙØ©","Ù…ÙˆØ§ØµÙ„Ø§Øª","ØªØ³ÙˆÙŠÙ‚","Ù…ØµØ§Ø±ÙŠÙ Ø¨Ù†ÙƒÙŠØ©","Ø£Ø®Ø±Ù‰"].map(c=>`<option ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº *</label><input class="form-input" id="f-amount" type="number" value="${item?.amount||''}"></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label><select class="form-input" id="f-month">${mOpts}</select></div>
    <div class="form-field"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input class="form-input" id="f-note" value="${item?.note||''}"></div>
    <div style="display:flex;gap:10px"><button class="btn btn-red" style="flex:1" onclick="saveExp(${id||'null'})">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='material') return`
    <div class="modal-title">${isEdit?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©':'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø®Ø§Ù…'}</div>
    <div class="form-field"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© *</label><input class="form-input" id="f-name" value="${item?.name||''}" placeholder="Ø¯Ù‚ÙŠÙ‚ØŒ Ø³ÙƒØ±..."></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label><input class="form-input" id="f-qty" type="number" value="${item?.qty||''}"></div>
      <div class="form-field"><label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label><select class="form-input" id="f-unit">${["ÙƒÙŠÙ„Ùˆ","Ù„ØªØ±","Ø¹Ù„Ø¨Ø©","ÙƒØ±ØªÙˆÙ†","ÙƒÙŠØ³","Ù‚Ø·Ø¹Ø©"].map(u=>`<option ${item?.unit===u?'selected':''}>${u}</option>`).join('')}</select></div>
    </div>
    <div class="form-field"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© *</label><input class="form-input" id="f-uc" type="number" step="0.01" value="${item?.unitCost||''}"></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label><select class="form-input" id="f-month">${mOpts}</select></div>
    <div style="display:flex;gap:10px"><button class="btn btn-orange" style="flex:1" onclick="saveMat(${id||'null'})">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='revenue') return`
    <div class="modal-title">${isEdit?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯':'Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯'}</div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ù…ØµØ¯Ø± *</label><input class="form-input" id="f-source" value="${item?.source||''}" placeholder="Ù…Ø¨ÙŠØ¹Ø§Øª Ø®Ø¨Ø²..."></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº *</label><input class="form-input" id="f-amount" type="number" value="${item?.amount||''}"></div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label><select class="form-input" id="f-month">${mOpts}</select></div>
    <div style="display:flex;gap:10px"><button class="btn btn-green" style="flex:1" onclick="saveRev(${id||'null'})">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='rent') return`
    <div class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</div>
    <div class="form-field"><label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</label><input class="form-input" id="f-amount" type="number" value="${appData.rent.amount}"></div>
    <div class="form-field"><label class="form-label">ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input class="form-input" id="f-dueday" type="number" min="1" max="31" value="${appData.rent.dueDay}"></div>
    <div class="form-field"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input class="form-input" id="f-note" value="${appData.rent.note||''}"></div>
    <div style="display:flex;gap:10px"><button class="btn btn-purple" style="flex:1" onclick="saveRent()">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='product') return`
    <div class="modal-title">${isEdit?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬':'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬'}</div>
    <div class="form-field"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label><input class="form-input" id="f-name" value="${item?.name||''}" placeholder="Ø®Ø¨Ø² Ø£Ø¨ÙŠØ¶..."></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Ø§Ù„ÙØ¦Ø©</label><select class="form-input" id="f-cat">${["Ø®Ø¨Ø²","Ù…Ø¹Ø¬Ù†Ø§Øª","Ø­Ù„ÙˆÙŠØ§Øª","Ù…Ø´Ø±ÙˆØ¨Ø§Øª","Ø¥Ø¶Ø§ÙØ§Øª","Ø¹Ø§Ù…"].map(c=>`<option ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="form-field"><label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label><select class="form-input" id="f-unit">${["Ù‚Ø·Ø¹Ø©","Ø±ØºÙŠÙ","ÙƒÙŠØ³","ÙƒÙŠÙ„Ùˆ","Ø¹Ù„Ø¨Ø©","Ù„ØªØ±","Ø¯Ø²ÙŠÙ†Ø©"].map(u=>`<option ${item?.unit===u?'selected':''}>${u}</option>`).join('')}</select></div>
    </div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label><input class="form-input" id="f-price" type="number" step="0.01" value="${item?.price||''}"></div>
      <div class="form-field"><label class="form-label">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</label><input class="form-input" id="f-cost" type="number" step="0.01" value="${item?.cost||''}"></div>
    </div>
    <div class="form-field"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
      <div style="display:flex;gap:7px"><input class="form-input" id="f-bc" style="flex:1" value="${item?.barcode||''}" oninput="refreshMBC()"><button class="btn btn-dark btn-sm" onclick="document.getElementById('f-bc').value=genBC();refreshMBC()">ğŸ”„ ØªÙˆÙ„ÙŠØ¯</button></div>
    </div>
    <div id="mbc-wrap" style="background:#fff;border-radius:8px;padding:10px;margin-bottom:12px;display:${item?.barcode?'flex':'none'};justify-content:center"><canvas id="mbc"></canvas></div>
    <div style="display:flex;gap:10px"><button class="btn btn-gold" style="flex:1" onclick="saveProd(${id||'null'})">Ø­ÙØ¸</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  if(type==='newuser') return`
    <div class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</div>
    <div class="hint-box hint-gold">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
    <div class="form-field"><label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label><input class="form-input" id="f-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"></div>
    <div class="form-field"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… * (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input class="form-input" id="f-uname" placeholder="Ù…Ø«Ø§Ù„: khalid2" dir="ltr"></div>
    <div class="form-field"><label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label><input class="form-input" id="f-pw" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <div class="form-field"><label class="form-label">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label><select class="form-input" id="f-role"><option value="user">Ù…ÙˆØ¸Ù Ø¹Ø§Ø¯ÙŠ</option><option value="admin">Ù…Ø¯ÙŠØ±</option></select></div>
    <div style="display:flex;gap:10px"><button class="btn btn-green" style="flex:1" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button><button class="btn btn-dark" style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button></div>`;
}

function refreshMBC(){
  const v=document.getElementById('f-bc')?.value;
  const w=document.getElementById('mbc-wrap');
  if(w)w.style.display=v?'flex':'none';
  if(v)setTimeout(()=>drawBarcode('mbc',v,200,43),50);
}

// ==========================================
//  CRUD
// ==========================================
const gv=id=>document.getElementById(id)?.value?.trim()||'';
const gn=id=>parseFloat(document.getElementById(id)?.value)||0;

function saveEmp(id){
  const name=gv('f-name'),salary=gn('f-salary');
  if(!name||!salary){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  const emp={id:id||Date.now(),name,role:gv('f-role'),salary,housing:gn('f-housing')};
  if(id)appData.employees=appData.employees.map(e=>e.id===id?emp:e);else appData.employees.push(emp);
  closeModal();scheduleSave();renderMain();notify(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function saveExp(id){
  const cat=gv('f-cat'),amount=gn('f-amount');
  if(!cat||!amount){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  const exp={id:id||Date.now(),category:cat,amount,month:gv('f-month')||appData.currentMonth,note:gv('f-note')};
  if(id)appData.expenses=appData.expenses.map(e=>e.id===id?exp:e);else appData.expenses.push(exp);
  closeModal();scheduleSave();renderMain();notify(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function saveMat(id){
  const name=gv('f-name'),qty=gn('f-qty'),uc=gn('f-uc');
  if(!name||!qty||!uc){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  const mat={id:id||Date.now(),name,qty,unit:gv('f-unit')||'ÙƒÙŠÙ„Ùˆ',unitCost:uc,month:gv('f-month')||appData.currentMonth};
  if(id)appData.rawMaterials=appData.rawMaterials.map(m=>m.id===id?mat:m);else appData.rawMaterials.push(mat);
  closeModal();scheduleSave();renderMain();notify(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function saveRev(id){
  const source=gv('f-source'),amount=gn('f-amount');
  if(!source||!amount){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  const rev={id:id||Date.now(),source,amount,month:gv('f-month')||appData.currentMonth};
  if(id)appData.revenue=appData.revenue.map(r=>r.id===id?rev:r);else appData.revenue.push(rev);
  closeModal();scheduleSave();renderMain();notify(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function saveRent(){
  appData.rent={amount:gn('f-amount')||appData.rent.amount,dueDay:gn('f-dueday')||1,note:gv('f-note')};
  closeModal();scheduleSave();renderMain();notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±');
}
function saveProd(id){
  const name=gv('f-name'),price=gn('f-price');
  if(!name||!price){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  if(!appData.products)appData.products=[];
  const prod={id:id||Date.now(),name,category:gv('f-cat')||'Ø¹Ø§Ù…',price,cost:gn('f-cost'),unit:gv('f-unit')||'Ù‚Ø·Ø¹Ø©',barcode:gv('f-bc')||genBC()};
  if(id)appData.products=appData.products.map(p=>p.id===id?prod:p);else appData.products.push(prod);
  closeModal();scheduleSave();renderMain();notify(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬');
  setTimeout(drawAllBarcodes,80);
}
function del(type,id){
  const map={employee:'employees',expense:'expenses',material:'rawMaterials',revenue:'revenue',product:'products'};
  const key=map[type];if(!key)return;
  appData[key]=(appData[key]||[]).filter(x=>x.id!==id);
  scheduleSave();renderMain();notify('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}
async function addUser(){
  const name=gv('f-name'),username=gv('f-uname'),password=gv('f-pw'),role=gv('f-role');
  if(!name||!username||!password){notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„','error');return;}
  const res=await apiFetch('/api/users',{method:'POST',body:JSON.stringify({name,username,password,role})});
  if(res?.ok){closeModal();notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… âœ…');loadUsersList();}
  else notify(res?.error||'Ø®Ø·Ø£','error');
}
async function deleteUser(id){
  const res=await apiFetch('/api/users/'+id,{method:'DELETE'});
  if(res?.ok){notify('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');loadUsersList();}
  else notify(res?.error||'Ø®Ø·Ø£','error');
}
async function changePassword(){
  const oldp=gv('oldpw'),newp=gv('newpw'),conp=gv('conpw');
  const msg=document.getElementById('pw-msg');
  if(!oldp||!newp){msg.style.display='block';msg.style.color='var(--red)';msg.textContent='ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„';return;}
  if(newp!==conp){msg.style.display='block';msg.style.color='var(--red)';msg.textContent='ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†';return;}
  const res=await apiFetch('/api/change-password',{method:'POST',body:JSON.stringify({oldPassword:oldp,newPassword:newp})});
  msg.style.display='block';
  if(res?.ok){msg.style.color='var(--green)';msg.textContent='âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­';}
  else{msg.style.color='var(--red)';msg.textContent=res?.error||'Ø®Ø·Ø£';}
}

// ==========================================
//  PRINT
// ==========================================
function printLabel(id){
  const p=(appData.products||[]).find(x=>x.id===id);if(!p)return;
  const canvas=document.getElementById('bc-'+id);
  const img=canvas?canvas.toDataURL():'';
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap" rel="stylesheet"><style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f5f5f5;font-family:Cairo,sans-serif}.c{background:#fff;border-radius:12px;padding:20px 24px;text-align:center;width:290px;box-shadow:0 4px 20px rgba(0,0,0,.15)}.brand{font-size:11px;color:#999;margin-bottom:4px}.name{font-size:17px;font-weight:700}.cat{font-size:11px;color:#888;margin-bottom:12px}.price{font-size:30px;font-weight:900;color:#c0392b;margin-top:6px}.vat{font-size:10px;color:#aaa}@media print{body{background:#fff}}</style></head><body><div class="c"><div class="brand">ğŸ¥– CRMB</div><div class="name">${p.name}</div><div class="cat">${p.category} â€¢ ${p.unit}</div>${img?`<img src="${img}" style="width:100%;max-width:250px">`:'<div style="color:#999;padding:10px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯</div>'}<div class="price">${fc(p.price)}</div><div class="vat">Ø§Ù„Ø³Ø¹Ø± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div></div><script>window.onload=()=>{window.print();}<\/script></body></html>`);
  w.document.close();
}
function printAllBC(){
  const prods=appData.products||[];if(!prods.length){notify('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª','error');return;}
  const items=prods.map(p=>{const c=document.getElementById('bc-'+p.id);const img=c?c.toDataURL():'';return`<div class="item"><div class="name">${p.name}</div>${img?`<img src="${img}" style="width:100%;max-width:180px">`:''}  <div class="price">${fc(p.price)}</div><div class="unit">${p.unit}</div></div>`;}).join('');
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&display=swap" rel="stylesheet"><style>body{margin:16px;font-family:Cairo,sans-serif}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.item{border:1px solid #ddd;border-radius:8px;padding:12px;text-align:center}.name{font-size:12px;font-weight:700;margin-bottom:5px}.price{font-size:17px;font-weight:900;color:#c0392b}.unit{font-size:9px;color:#aaa}@media print{body{margin:4px}}</style></head><body><div class="grid">${items}</div><script>window.onload=()=>{window.print();}<\/script></body></html>`);
  w.document.close();
}

// ==========================================
//  EXPORT EXCEL
// ==========================================
function exportExcel(){
  const s=calcStats();const cm=appData.currentMonth;
  const wb=XLSX.utils.book_new();
  const add=(name,rows)=>XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),name);
  add("Ø§Ù„Ù…Ù„Ø®Øµ",[["CRMB - Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø¨Ø²"],["Ø§Ù„ØªÙ‚Ø±ÙŠØ±: "+ml(cm)],[],["Ø§Ù„Ø¨Ù†Ø¯","Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)"],["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",s.totalRev],["Ø±ÙˆØ§ØªØ¨ ÙˆØ³ÙƒÙ†",s.totalSalaries],["Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…",s.totalRaw],["Ø¥ÙŠØ¬Ø§Ø±",appData.rent.amount],["Ù…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„",s.totalExp],["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ",s.totalCosts],[],[s.netProfit>=0?"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­":"ØµØ§ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©",Math.abs(s.netProfit)],["Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ %",s.margin+"%"]]);
  add("Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",[["Ø§Ù„Ù…ØµØ¯Ø±","Ø§Ù„Ø´Ù‡Ø±","Ø§Ù„Ù…Ø¨Ù„Øº"],...appData.revenue.map(r=>[r.source,ml(r.month),r.amount])]);
  add("Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†",[["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù…Ù†ØµØ¨","Ø§Ù„Ø±Ø§ØªØ¨","Ø§Ù„Ø³ÙƒÙ†","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"],...appData.employees.map(e=>[e.name,e.role,e.salary,e.housing,e.salary+e.housing])]);
  add("Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…",[["Ø§Ù„Ù…Ø§Ø¯Ø©","Ø§Ù„ÙƒÙ…ÙŠØ©","Ø§Ù„ÙˆØ­Ø¯Ø©","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø´Ù‡Ø±"],...appData.rawMaterials.map(r=>[r.name,r.qty,r.unit,r.unitCost,r.qty*r.unitCost,ml(r.month)])]);
  add("Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ",[["Ø§Ù„ØªØµÙ†ÙŠÙ","Ø§Ù„Ù…Ø¨Ù„Øº","Ø§Ù„Ø´Ù‡Ø±","Ù…Ù„Ø§Ø­Ø¸Ø©"],...appData.expenses.map(e=>[e.category,e.amount,ml(e.month),e.note||""])]);
  add("Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯",[["Ø§Ù„Ù…Ù†ØªØ¬","Ø§Ù„ÙØ¦Ø©","Ø§Ù„ÙˆØ­Ø¯Ø©","Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹","Ø§Ù„ØªÙƒÙ„ÙØ©","Ø§Ù„Ø±Ø¨Ø­","Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"],...(appData.products||[]).map(p=>[p.name,p.category,p.unit,p.price,p.cost,p.price-p.cost,p.barcode])]);
  XLSX.writeFile(wb,`CRMB_${ml(cm).replace(' ','_')}.xlsx`);
  notify('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Excel!');
}

// ==========================================
//  AUTH
// ==========================================
async function doLogout(){
  await apiFetch('/api/logout',{method:'POST'});
  window.location.href='/login';
}

// ==========================================
//  NOTIFICATION
// ==========================================
function notify(msg,type='success'){
  const n=document.getElementById('notif');
  n.textContent=msg;n.style.background=type==='error'?'#c0392b':'#27ae60';
  n.style.display='block';setTimeout(()=>n.style.display='none',3000);
}

// ==========================================
//  INIT
// ==========================================
async function init(){
  // Load user
  currentUser = await apiFetch('/api/me');
  if(!currentUser){window.location.href='/login';return;}
  document.getElementById('userBadge').textContent = 'ğŸ‘¤ '+currentUser.name;

  // Init month select
  const sel=document.getElementById('monthSelect');
  // Load data then init
  await loadData();
  sel.innerHTML=MONTHS.map(m=>`<option value="${m}" ${m===appData.currentMonth?'selected':''}>${ml(m)}</option>`).join('');

  renderMain();

  // Auto-refresh every 15 seconds (sync with other devices)
  setInterval(async()=>{
    const old=JSON.stringify(appData);
    await loadData();
    if(JSON.stringify(appData)!==old && currentTab!=='barcode') renderMain();
    else if(JSON.stringify(appData)!==old && currentTab==='barcode'){renderMain();setTimeout(drawAllBarcodes,80);}
  }, 15000);

  // Load users list when on users tab
  setInterval(()=>{if(currentTab==='users')loadUsersList();},2000);
}

init();
</script>
</body>
</html>
